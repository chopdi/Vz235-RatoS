#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]
[include Macros.cfg]
#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_beacon_scan_compensation_enable: true         
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_safe_home_x: "middle"
variable_safe_home_y: "middle"


#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact.
###    IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading
###    the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

##### Vz235############
#######################
[printer]
kinematics: corexy
max_velocity: 2500
max_accel: 30000
minimum_cruise_ratio: 0.5
square_corner_velocity: 20
max_z_velocity: 15
max_z_accel: 150

[gcode_macro RatOS]
variable_macro_travel_speed: 500
variable_macro_travel_accel: 10000
#------------------------------------------------- Input Shaper -------------------------------------------------
[input_shaper]
shaper_freq_x: 108.6
shaper_type_x: mzv
shaper_freq_y: 74.4
shaper_type_y: mzv
damping_ratio_x: 0.058
damping_ratio_y: 0.095



#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
microsteps: 64
position_max: 235
position_endstop: 0
position_min: 0
homing_speed: 50
[tmc5160 stepper_x] 
interpolate: false
run_current: 1.6
stealthchop_threshold: 0
[stepper_x1]
step_pin: PE2 
dir_pin: !PE1 
enable_pin: !PE0 
rotation_distance: 40
microsteps: 64
full_steps_per_rotation: 200
[tmc5160 stepper_x1] 
cs_pin: PD4
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
##diag1_pin: PF1
sense_resistor: 0.022
interpolate: false
run_current: 1.6
stealthchop_threshold: 0 
#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
microsteps: 64
position_max: 232.5
position_endstop: 0
position_min: 0
homing_speed: 50
[tmc5160 stepper_y] 
interpolate: false
run_current: 1.6
stealthchop_threshold: 0

[stepper_y1]
step_pin: PB9
dir_pin: !PB8
enable_pin: !PB7
rotation_distance: 40
microsteps: 64
full_steps_per_rotation: 200
[tmc5160 stepper_y1] 
cs_pin: PD3
spi_software_sclk_pin: PC6
spi_software_mosi_pin: PC8
spi_software_miso_pin: PC7
##diag1_pin: PF2
run_current: 1.6
sense_resistor: 0.022
stealthchop_threshold: 0
#############################################################################################################
### HOMING
#############################################################################################################
[include RatOS/z-probe/beacon.cfg]


# Physical X endstop configuration
[stepper_x]
endstop_pin: PF10 
[gcode_macro RatOS]
variable_homing_x: "endstop"

# Physical Y endstop configuration
[stepper_y]
endstop_pin: PC0
[gcode_macro RatOS]
variable_homing_y: "endstop"

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 2      # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -2
position_max: 169
[tmc5160 stepper_z]
run_current: 1.2


#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: z1_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 2      # 4 for TR8*4 lead screws
[tmc5160 stepper_z1]
run_current: 1.2

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: z2_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 2      # 4 for TR8*4 lead screws
[tmc5160 stepper_z2]
run_current: 1.2

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: e_dir_pin        # Add ! in front of pin name to reverse the direction of extruder
rotation_distance: 35.8   # VzBot VZ-HextrudORT Plus default
pressure_advance: 0.03   # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
sensor_type:MAX31865
sensor_pin: PC9
spi_bus: spi3a
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300
#------------------------------------------------- Heater Bed -------------------------------------------------
[heater_bed]
#control: pid
heater_pin: PF5
sensor_type: Generic 3950
sensor_pin: PC4
min_temp: 0 
pwm_cycle_time: 0.02 # 50hz for european AC, to avoid flickering lights.
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

#------------------------------------------------- Chamber Heater -------------------------------------------------
[temperature_sensor chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
pullup_resistor: 4700
sensor_pin: PB0
min_temp: 0
max_temp: 80
#gcode_id: C: C
[heater_generic chamber_heater]
heater_pin: PF8
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PA7
pullup_resistor: 4700
control: watermark
#pid_kp = 0
#pid_ki = 0
#pid_kd = 0
#max_power: .5
min_temp:  0
max_temp: 100
[heater_fan chamber_heater_fan]
##	Chamber Fan - FAN8 24V Connector
pin: PA5
max_power: 1.0
kick_start_time: 0.5
heater: chamber_heater
heater_temp: 30.0
[verify_heater chamber_heater]
max_error: 100
check_gain_time: 100
hysteresis: 5
heating_gain: 2
#------------------------------------------------- Bed Edge Sensor -------------------------------------------------
[temperature_sensor bed_edge]
sensor_type:  ATC Semitec 104GT-2
pullup_resistor: 4700
sensor_pin: PB1
min_temp: 0
max_temp: 125
#------------------------------------------------- Stepper Driver Sensor -------------------------------------------------
[temperature_sensor Stepper_Driver_2160HV]
sensor_type: ATC Semitec 104NT-4-R025H42G
pullup_resistor: 4700
sensor_pin: PC5
min_temp: 0
max_temp: 100
#gcode_id: C: C
#------------------------------------------------- Fans -------------------------------------------------
# Hotend cooling fan
[heater_fan toolhead_cooling_fan]
heater: extruder
# 4-pin fan connected to 2-pin header on Kraken - digital pwm
pin: PA0
cycle_time:  0.00004
# Part cooling fan
[fan]
# 4-pin fan connected to 2-pin header on Kraken - digital pwm
pin: rpi:gpio26
max_power: 1
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0
[fan_generic RSCS]
pin: PA4
max_power: 1
shutdown_speed: 0
kick_start_time: 0.1
off_below: 0.10
[fan_generic Exhaust_fan]
#  Nevermore - In E1 OUT Position
pin: PA3
max_power: 1.0
kick_start_time: 0.5
#------------------------------------------------- Bed Mesh -------------------------------------------------
[bed_mesh]
speed: 400
horizontal_move_z: 2
mesh_min: 30,28
mesh_max: 205,165
algorithm: bicubic
#fade_start: 1
#fade_end: 10
#split_delta_z: .025
#move_check_distance: 5
probe_count: 30,30
mesh_pps: 0,0
bicubic_tension: 0.1
zero_reference_position: 117.5 , 117.5
#------------------------------------------------- Z_Tilt -------------------------------------------------
[z_tilt]
 z_positions: #Kugeln
   -65.00, 0                
    112.50, 283                
    300, 0 
points: #Probpunkte
  20, 5      
  20, 165 
  215, 5

#------------------------------------------------- Resonance Tester -------------------------------------------------
[resonance_tester]
probe_points: 117.5, 117.5,20
#------------------------------------------------- Beacon -------------------------------------------------
[beacon]
serial:/dev/serial/by-id/usb-Beacon_Beacon_RevH_40708F584E5737374D202020FF113208-if00 
y_offset: 27.065
#   Y offset of beacon from the nozzle.
mesh_main_direction: x
contact_max_hotend_temperature: 305 # increase to enable hot contacting
# Temperature limit for the hotend when contacting, override this for temps which may damage some surfaces.

#------------------------------------------------- Neopixel -------------------------------------------------
[neopixel neo]
pin:PF12
chain_count:20
color_order:GRBW
initial_RED:0
initial_GREEN:0
initial_BLUE:1
initial_WHITE:0
[neopixel neo2]
pin:PF11
chain_count:5
color_order:GRB
initial_RED:0
initial_GREEN:0
initial_BLUE:1



######################################################################
# Fysetc Mini 12864Panel v2.1 (with neopixel backlight leds)
######################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
contrast: 63
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
## Some micro-controller boards may require an spi bus to be specified:
#spi_bus: spi
## Alternatively, some micro-controller boards may work with software spi:
#spi_software_miso_pin: EXP2_1
#spi_software_mosi_pin: EXP2_6
#spi_software_sclk_pin: EXP2_2

[output_pin beeper]
pin: EXP1_1

[neopixel fly_mini12864]
pin: EXP1_6
chain_count: 3
initial_RED: 0
initial_GREEN: 1.0
initial_BLUE: 0.0
color_order: RGB

#	Set RGB values on boot up for each Neopixel. 
#	Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode setdisplayneopixel]
initial_duration: 1
gcode:
        SET_LED LED=fly_mini12864 RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=1 TRANSMIT=0
        SET_LED LED=fly_mini12864 RED=1.0 GREEN=0.0 BLUE=0.0 INDEX=2 TRANSMIT=0
        SET_LED LED=fly_mini12864 RED=0.0 GREEN=1.0 BLUE=0.0 INDEX=3 


# This file defines the default layout of the printer's lcd display.

# It is not necessary to edit this file to change the display.
# Instead, one may override any of the sections defined here by
# defining a section with the same name in the main printer.cfg config
# file.


######################################################################
# Helper macros for showing common screen values
######################################################################

[display_template _heater_temperature]
param_heater_name: "extruder"
text:
  {% if param_heater_name in printer %}
    {% set heater = printer[param_heater_name] %}
    # Show glyph
    {% if param_heater_name == "heater_bed" %}
      {% if heater.target %}
        {% set frame = (printer.toolhead.estimated_print_time|int % 2) + 1 %}
        ~bed_heat{frame}~
      {% else %}
        ~bed~
      {% endif %}
    {% else %}
      ~extruder~
    {% endif %}
    # Show temperature
    { "%3.0f" % (heater.temperature,) }
    # Optionally show target
    {% if heater.target and (heater.temperature - heater.target)|abs > 2 %}
      ~right_arrow~
      { "%0.0f" % (heater.target,) }
    {% endif %}
    ~degrees~
  {% endif %}



[display_template _fan_speed]
text:
  {% if 'fan' in printer %}
    {% set speed = printer.fan.speed %}
    {% if speed %}
      {% set frame = (printer.toolhead.estimated_print_time|int % 2) + 1 %}
      ~fan{frame}~
    {% else %}
      ~fan1~
    {% endif %}
    { "{:>4.0%}".format(speed) }
  {% endif %}

[display_template _printing_time]
text:
  {% set ptime = printer.idle_timeout.printing_time %}
  { "%02d:%02d" % (ptime // (60 * 60), (ptime // 60) % 60) }

[display_template _print_status]
text:
  {% if printer.display_status.message %}
    { printer.display_status.message }
  {% elif printer.idle_timeout.printing_time %}
    {% set pos = printer.toolhead.position %}
    { "X%-4.0fY%-4.0fZ%-5.2f" % (pos.x, pos.y, pos.z) }
  {% else %}
    { "VzBot 83 " }
	~CHOP3D~
  {% endif %}


######################################################################
# Default 16x4 display
######################################################################

[display_data _default_16x4 extruder]
position: 0, 0
text:
  {% set active_extruder = printer.toolhead.extruder %}
  { render("_heater_temperature", param_heater_name=active_extruder) }

[display_data _default_16x4 fan]
position: 0, 10
text: { render("_fan_speed") }

[display_data _default_16x4 heater_bed]
position: 1, 0
text: { render("_heater_temperature", param_heater_name="heater_bed") }

[display_data _default_16x4 speed_factor]
position: 1, 10
text:
  ~feedrate~
  { "{:>4.0%}".format(printer.gcode_move.speed_factor) }

[display_data _default_16x4 print_progress]
position: 2, 0
text: { "{:^10.0%}".format(printer.display_status.progress) }
[display_data _default_16x4 progress_bar]
position: 2, 1 # Draw graphical progress bar after text is written
text: { draw_progress_bar(2, 0, 10, printer.display_status.progress) }

[display_data _default_16x4 printing_time]
position: 2, 10
text: { "%6s" % (render("_printing_time").strip(),) }

[display_data _default_16x4 print_status]
position: 3, 0
text: { render("_print_status") }





######################################################################
# Default 16x4 glyphs
######################################################################

[display_glyph extruder]
data:
  ................
  ................
  ..************..
  .....******.....
  ..************..
  .....******.....
  ..************..
  ................
  ....********....
  ....******.*....
  ....********....
  ................
  ......****......
  .......**.......
  ................
  ................

[display_glyph bed]
data:
  ................
  ................
  ................
  ................
  ................
  ................
  ................
  ................
  ................
  ................
  ................
  ...*********....
  ..*.........*...
  .*************..
  ................
  ................

[display_glyph bed_heat1]
data:
  ................
  ................
  ..*....*....*...
  .*....*....*....
  ..*....*....*...
  ...*....*....*..
  ..*....*....*...
  .*....*....*....
  ..*....*....*...
  ................
  ................
  ...*********....
  ..*.........*...
  .*************..
  ................
  ................

[display_glyph bed_heat2]
data:
  ................
  ................
  ..*....*....*...
  ...*....*....*..
  ..*....*....*...
  .*....*....*....
  ..*....*....*...
  ...*....*....*..
  ..*....*....*...
  ................
  ................
  ...*********....
  ..*.........*...
  .*************..
  ................
  ................

[display_glyph fan1]
data:
  ................
  ................
  ....***.........
  ...****....**...
  ...****...****..
  ....***..*****..
  .....*....****..
  .......**.......
  .......**.......
  ..****....*.....
  ..*****..***....
  ..****...****...
  ...**....****...
  .........***....
  ................
  ................

[display_glyph fan2]
data:
  ................
  ................
  .......****.....
  .......****.....
  .......***......
  ..**...**.......
  ..***...........
  ..****.**.****..
  ..****.**.****..
  ...........***..
  .......**...**..
  ......***.......
  .....****.......
  .....****.......
  ................
  ................

[display_glyph feedrate]
data:
  ................
  ................
  ***.***.***.**..
  *...*...*...*.*.
  **..**..**..*.*.
  *...*...*...*.*.
  *...***.***.**..
  ................
  **...*..***.***.
  *.*.*.*..*..*...
  **..***..*..**..
  *.*.*.*..*..*...
  *.*.*.*..*..***.
  ................
  ................
  ................

[display_glyph chamber]
data:
  ................
  ****************
  *....*....*....*
  *....*....*....*
  *....******....*
  *..............*
  *..............*
  *.....****.....*
  *.***.*..*.***.*
  *.....****.....*
  *......**......*
  *..............*
  *.************.*
  *...*......*...*
  ****************
  ................

[board_pins]
aliases:
    # FPC header, Aliases EXP1 & EXP2 for mini12864
    EXP1_1=PG5, EXP1_2=PG4,
    EXP1_3=PG3, EXP1_4=PG2,
    EXP1_5=PD15, EXP1_6=PD14,
    EXP1_7=PD13, EXP1_8=PD12,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PG8, EXP2_4=PE11,
    EXP2_5=PG7, EXP2_6=PE14,
    EXP2_7=PG6, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>









# REMEMBER TO CALIBRATE YOUR BEACON!
# Run BEACON_RATOS_CALIBRATE for automatic calibration.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.930
#*# pid_ki = 1.643
#*# pid_kd = 73.190
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.050
#*# pid_ki = 2.567
#*# pid_kd = 243.992
#*#
#*# [beacon model default]
#*# model_coef = 1.5838975255561598,
#*# 	  1.8914950547957143,
#*# 	  0.7390805274462932,
#*# 	  0.3273733103978733,
#*# 	  0.17885787777349232,
#*# 	  0.23229739155462617,
#*# 	  0.0367016157742688,
#*# 	  -0.15965580669741006,
#*# 	  0.06149494017354098,
#*# 	  0.11231040840884175
#*# model_domain = 1.8856212481506885e-07,1.940262932246171e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 71.935195
#*# model_offset = 0.00000
